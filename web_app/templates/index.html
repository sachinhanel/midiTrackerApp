{% extends "layout.html" %}
{% block content %}
<section id="dashboard">
  <h2>Live Dashboard</h2>
  <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;">
    <div>Live status: <span id="live_status">DISCONNECTED</span></div>
    <div>Last update: <span id="last_update">—</span></div>
  </div>

  <div class="panel">
    <h3>MIDI Device Connection</h3>
    <div style="margin-bottom: 12px;">
      <button id="refresh_devices" style="padding: 8px 16px;">Refresh Devices</button>
      <ul id="device_list" style="margin-top: 8px;"></ul>
    </div>
    <div style="display: flex; gap: 8px; align-items: center;">
      <label for="device_select"><strong>Select device:</strong></label>
      <select id="device_select" style="padding: 6px; flex: 1;"></select>
      <button id="select_btn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Connect</button>
    </div>
    <div id="device_status" style="margin-top: 8px; color: #666;"></div>
  </div>

  <div class="panel">
    <h3>Active Notes</h3>
    <div id="active_notes">—</div>
  </div>

  <div class="panel">
    <h3>Throughput</h3>
    <div id="throughput">0 B/s</div>
  </div>

  <div class="panel">
    <h3>Pedal</h3>
    <div id="pedal">Up</div>
  </div>

  <div class="panel">
    <h3>Debug</h3>
    <pre id="debug" style="max-height:260px;overflow:auto;white-space:pre-wrap;"></pre>
  </div>
</section>

<script>
// Device management functions
async function fetchDevices() {
  try {
    const r = await fetch('/api/control/devices');
    const j = await r.json();
    const list = document.getElementById('device_list');
    const sel = document.getElementById('device_select');
    list.innerHTML = '';
    sel.innerHTML = '';
    if (j.ok) {
      j.devices.forEach((d, i) => {
        const li = document.createElement('li');
        li.textContent = `${i}: ${d}`;
        list.appendChild(li);
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = d;
        sel.appendChild(opt);
      });
    } else {
      list.innerHTML = '<li>Error fetching devices</li>';
    }
  } catch (e) {
    console.error(e);
    const list = document.getElementById('device_list');
    list.innerHTML = '<li>Control API unreachable (is the main app running?)</li>';
  }
}

async function selectDevice() {
  const sel = document.getElementById('device_select');
  const idx = sel.value;
  try {
    const r = await fetch('/api/control/select', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({index: parseInt(idx)})
    });
    const j = await r.json();
    const status = document.getElementById('device_status');
    if (j.ok) status.textContent = 'Device connection requested successfully';
    else status.textContent = 'Error: '+(j.error||'unknown');
  } catch (e) {
    console.error(e);
    document.getElementById('device_status').textContent = 'Error contacting control API';
  }
}

// Initialize device management when page loads
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('refresh_devices').addEventListener('click', fetchDevices);
  document.getElementById('select_btn').addEventListener('click', selectDevice);
  fetchDevices(); // Auto-fetch on page load
});
</script>
{% endblock %}
