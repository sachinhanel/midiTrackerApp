{% extends "layout.html" %}
{% block content %}
<section id="stats">
  <h2>Statistics</h2>

  <!-- Toggle for number format -->
  <div style="margin-bottom: 12px;">
    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
      <input type="checkbox" id="format_toggle" checked>
      <strong>Show shortened numbers (e.g., 367.2k)</strong>
    </label>
  </div>

  <!-- All-time totals box -->
  <div style="margin-bottom: 8px;"><strong>All-time Totals:</strong></div>
  <div id="top_totals_box" style="display:flex; gap:12px; margin-bottom:12px;">
  <div class="small_total_card"><div class="small_total_value" id="total_notes_top">-</div><div class="small_total_label">All-time Notes</div></div>
  <div class="small_total_card"><div class="small_total_value" id="total_energy_top">-</div><div class="small_total_label">All-time Energy (J)</div></div>
  <div class="small_total_card"><div class="small_total_value" id="total_note_hours_top">-</div><div class="small_total_label">Note Duration (hrs)</div></div>
    <div class="small_total_card"><div class="small_total_value" id="total_practice_hours_top">-</div><div class="small_total_label">Practice Hours</div></div>
    <div class="small_total_card"><div class="small_total_value" id="total_pedal_presses_top">-</div><div class="small_total_label">Pedal Presses</div></div>
    <div class="small_total_card"><div class="small_total_value" id="total_midi_mb_top">-</div><div class="small_total_label">MIDI data (MB)</div></div>
  </div>

  <!-- Time-series totals box (changes based on selected range) -->
  <div style="margin-bottom: 8px;"><strong><span id="range_totals_label">Daily</span> Totals:</strong></div>
  <div id="range_totals_box" style="display:flex; gap:12px; margin-bottom:12px;">
    <div class="small_total_card"><div class="small_total_value" id="range_total_notes">-</div><div class="small_total_label"><span id="range_label_notes">Notes</span></div></div>
    <div class="small_total_card"><div class="small_total_value" id="range_total_energy">-</div><div class="small_total_label"><span id="range_label_energy">Energy (J)</span></div></div>
    <div class="small_total_card"><div class="small_total_value" id="range_note_hours">-</div><div class="small_total_label"><span id="range_label_note_hours">Note Duration (hrs)</span></div></div>
    <div class="small_total_card"><div class="small_total_value" id="range_practice_hours">-</div><div class="small_total_label"><span id="range_label_practice_hours">Practice Hours</span></div></div>
    <div class="small_total_card"><div class="small_total_value" id="range_midi_mb">-</div><div class="small_total_label"><span id="range_label_midi_mb">MIDI data (MB)</span></div></div>
  </div>

  <div class="panel">
    <h3>View</h3>
    <label for="range_select">Range:</label>
    <select id="range_select">
      <option value="hourly">Hourly</option>
      <option value="daily" selected>Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
      <option value="trends">Trends</option>
    </select>

    <label for="y_select">Y axis:</label>
    <select id="y_select">
      <option value="total_notes">Total Notes</option>
      <option value="total_energy" selected>Energy (J)</option>
      <option value="session_seconds">Session Time (s)</option>
    </select>
  </div>

  <div class="panel">
    <h3 id="chart_title">Time Series</h3>
    <div style="height:320px;"><canvas id="stats_chart" width="900" height="300"></canvas></div>
  </div>

  <div class="panel">
    <h3>Data</h3>
    <div id="stats_table">Loading…</div>
  </div>

  <div class="panel">
    <h3>Note Distribution (Per-Day)</h3>
  <label for="dist_date">Date:</label>
  <button id="dist_prev">Prev</button>
  <input type="date" id="dist_date" />
  <button id="dist_next">Next</button>
  <label style="margin-left:12px;">Heatmap:</label>
  <button id="heatmap_refresh">Refresh Heatmap</button>
    <div id="heatmap_area" style="margin-top:12px; display:flex; gap:12px; align-items:flex-start; position:relative;">
      <canvas id="heatmap_piano" width="900" height="120" style="border:1px solid #ccc;"></canvas>
      <div style="width:220px;">
        <div id="heatmap_legend"></div>
      </div>
      <div id="heatmap_tooltip" style="position:absolute; pointer-events:none; display:none; background:rgba(0,0,0,0.8); color:#fff; padding:6px 8px; border-radius:4px; font-size:12px;
           transform:translate(-50%,-120%);"></div>
    </div>
    <div id="big_totals" style="margin-top:10px; display:flex; gap:20px;">
      <div class="total_card"><div class="total_value" id="total_notes">-</div><div class="total_label">Total Notes</div></div>
      <div class="total_card"><div class="total_value" id="total_energy">-</div><div class="total_label">Total Energy (J)</div></div>
      <div class="total_card"><div class="total_value" id="avg_velocity">-</div><div class="total_label">Avg Velocity</div></div>
    </div>
    <div id="note_distribution_table" style="margin-top:12px; overflow:auto; max-height:360px;">Loading…</div>
  </div>

</section>
  <!-- Luxon + Chart.js + adapter for time scale -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <script src="/static/stats.js"></script>
{% endblock %}
